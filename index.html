<!-- SPORTSBOOK ODDS UI & LOGIC -->
<section class="px-6 mb-12 max-w-6xl mx-auto">
  <h3 class="text-3xl font-bold mb-4 text-white tracking-tight">Live Odds â€“ Compare Sportsbooks</h3>

  <!-- Sport Toggle -->
  <div class="flex gap-4 mb-8">
    <button
      v-for="s in ['basketball_nba', 'football_nfl', 'baseball_mlb']"
      :key="s"
      @click="changeSport(s)"
      :class="{
        'bg-blue-500 text-white': sport === s,
        'bg-gray-700 text-gray-200 hover:bg-gray-600': sport !== s
      }"
      class="px-4 py-2 rounded transition"
    >
      {{ s.replace('basketball_', 'NBA').replace('football_', 'NFL').replace('baseball_', 'MLB').toUpperCase() }}
    </button>
  </div>

  <div v-if="loading" class="text-gray-400">Loading live odds...</div>
  <div v-if="error" class="text-red-400">Error: {{ error }}</div>

  <div class="space-y-8" v-if="!loading && games.length">
    <div v-for="game in games" :key="game.id" class="glass rounded-xl p-6 card-shadow border border-gray-700">
      <div class="mb-4">
        <h4 class="text-2xl font-semibold text-white">
          {{ game.teams[0] }} vs {{ game.teams[1] }}
        </h4>
        <p class="text-gray-400 text-sm">Tap to select the best odds across books</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        <div
          v-for="(market, key) in game.bestMarkets"
          :key="key"
          class="glass rounded-lg p-4 border transition-all duration-200 cursor-pointer select-none"
          :class="{
            'border-blue-400 bg-blue-900/40 scale-[1.02] shadow-md': selectedPicks.includes(`${market.name} - ${market.sportsbook}`),
            'border-gray-600 hover:border-blue-300 hover:bg-blue-800/20': !selectedPicks.includes(`${market.name} - ${market.sportsbook}`)
          }"
          @click="selectPick(`${market.name} - ${market.sportsbook}`)"
        >
          <p class="text-base font-semibold text-white">{{ market.name }}</p>
          <p class="text-blue-300 text-xl font-bold mt-1">{{ market.price > 0 ? '+' + market.price : market.price }}</p>
          <p class="text-xs text-gray-400 mt-1">{{ market.sportsbook }}</p>
          <span class="text-[10px] text-emerald-300 mt-2 inline-block">Best Line</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Picks -->
  <div class="mt-10 glass p-6 rounded-xl card-shadow border border-gray-700">
    <h4 class="text-xl font-semibold mb-2 text-white">Your Picks</h4>
    <ul class="list-disc list-inside text-blue-200 text-sm space-y-1" v-if="selectedPicks.length">
      <li v-for="(pick, index) in selectedPicks" :key="index">{{ pick }}</li>
    </ul>
    <p class="text-gray-400 text-sm" v-else>No picks selected yet.</p>

    <button
      v-if="selectedPicks.length"
      class="mt-5 bg-white text-black font-semibold px-5 py-2 rounded hover:bg-gray-100 transition"
      @click="openParlay"
    >
      Open Parlay in Sportsbook
    </button>
  </div>
</section>

<script>
  const { createApp } = Vue;

  createApp({
    data() {
      return {
        sport: 'basketball_nba',
        games: [],
        selectedPicks: JSON.parse(localStorage.getItem('selectedPicks')) || [],
        loading: true,
        error: null,
      };
    },
    methods: {
      toggleTheme() {
        const html = document.documentElement;
        const isDark = html.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
      },

      selectPick(pick) {
        const index = this.selectedPicks.indexOf(pick);
        if (index === -1) {
          this.selectedPicks.push(pick);
        } else {
          this.selectedPicks.splice(index, 1);
        }
        localStorage.setItem("selectedPicks", JSON.stringify(this.selectedPicks));
      },

      openParlay() {
        if (!this.selectedPicks.length) {
          alert("Select at least one pick to create a parlay.");
          return;
        }

        // Check if all picks are from same sportsbook
        const books = this.selectedPicks.map(p => p.split(' - ')[1]);
        const uniqueBooks = [...new Set(books)];

        if (uniqueBooks.length === 1) {
          const book = uniqueBooks[0];
          // Replace this with deep linking logic for actual sportsbook if they support it
          alert(`Parlay ready for ${book}:\n\n${this.selectedPicks.join('\n')}`);
        } else {
          alert("To open the parlay in one sportsbook, all picks must come from the same one.");
        }
      },

      changeSport(newSport) {
        this.sport = newSport;
        this.fetchOdds();
      },

      async fetchOdds() {
        this.loading = true;
        this.error = null;

        const API_KEY = "3daa707ceb363f36b79f44bedc6abe2f";
        const region = "us";
        const market = "h2h,spreads,totals";

        try {
          const res = await fetch(
            `https://api.the-odds-api.com/v4/sports/${this.sport}/odds?apiKey=${API_KEY}&regions=${region}&markets=${market}&oddsFormat=american`
          );

          if (!res.ok) throw new Error("Failed to fetch odds");

          const data = await res.json();

          this.games = data.map(game => {
            const bestMarkets = {};

            ["h2h", "spreads", "totals"].forEach(type => {
              game.bookmakers.forEach(book => {
                const market = book.markets.find(m => m.key === type);
                if (market && market.outcomes) {
                  market.outcomes.forEach(outcome => {
                    const key = `${type}-${outcome.name}`;
                    if (
                      !bestMarkets[key] ||
                      Math.abs(outcome.price) > Math.abs(bestMarkets[key].price)
                    ) {
                      bestMarkets[key] = {
                        ...outcome,
                        sportsbook: book.title,
                        market: type,
                      };
                    }
                  });
                }
              });
            });

            return {
              id: game.id,
              teams: game.teams,
              home_team: game.home_team,
              bestMarkets,
            };
          });

          this.loading = false;
        } catch (err) {
          this.error = err.message;
          this.loading = false;
          console.error(err);
        }
      },
    },
    mounted() {
      this.fetchOdds();
    },
  }).mount("#app");
</script>
